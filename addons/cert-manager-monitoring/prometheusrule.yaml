apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels: {}
  name: cert-manager
  namespace: NAMESPACE_NAME # Substituted with the one from the deployment
spec:
  groups:
  - name: cert-manager.rules
    rules:
    - alert: CertRenewDeadline
      annotations:
        message: The certificate {{$labels.name}} in namespace {{$labels.exported_namespace}}
          is expiring in < 25 days
        summary: Certificate is expiring
      expr: label_replace(sum without(namespace) (certmanager_certificate_expiration_timestamp_seconds{}),"namespace","$1","exported_namespace",
        "(.*)") - time() < 2160000
      for: 15m
      labels:
        severity: critical
    - alert: CertStatusNotReady
      annotations:
        message: The certificate {{$labels.name}} in namespace {{$labels.exported_namespace}}
          is in status not True
        summary: Certificate in status not True
      expr: label_replace(sum without(namespace) (certmanager_certificate_ready_status{condition!="True"}),"namespace","$1","exported_namespace",
        "(.*)") == 1
      for: 15m
      labels:
        severity: critical
